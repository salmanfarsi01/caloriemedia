{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-7">
        
        <!-- FACEBOOK STYLE INPUT CARD -->
        <div class="card border-0 shadow-sm rounded-4 mb-4 p-3">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="d-flex align-items-start">
                    <!-- Avatar (Fixed Visibility) -->
                    <img src="{{ user.profile.image.url }}" 
                         onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';"
                         class="rounded-circle me-2 border" 
                         style="width: 45px; height: 45px; object-fit: cover; aspect-ratio: 1/1; object-position: center;">
                    
                    <!-- Input Area -->
                    <div class="w-100">
                        <textarea name="post_content" 
                                  class="form-control border-0 bg-light rounded-4 px-3 py-2" 
                                  rows="2" 
                                  style="resize: none;"
                                  placeholder="What's on your mind, {{ user.username }}?" required></textarea>
                        
                        <!-- Image Preview Script -->
                        <div id="image-preview" class="mt-2" style="display:none;">
                            <span class="badge bg-secondary" id="file-name-display"></span>
                        </div>
                    </div>
                </div>
                
                <hr class="my-2 text-muted opacity-25">
                
                <div class="d-flex justify-content-between align-items-center px-2">
                    <!-- Photo Button -->
                    <div class="position-relative">
                        <label for="file-upload" class="btn btn-sm btn-light text-secondary fw-bold rounded-pill px-3">
                            üñºÔ∏è Photo/Video
                        </label>
                        <input id="file-upload" type="file" name="post_image" style="display: none;" 
                               onchange="document.getElementById('image-preview').style.display='block'; document.getElementById('file-name-display').textContent = this.files[0].name;">
                    </div>

                    <!-- Custom Green Post Button -->
                    <button type="submit" class="btn text-white rounded-pill px-4 fw-bold btn-sm" style="background-color: #6ab04c; border: none;">Post</button>
                </div>
            </form>
        </div>

        <!-- FEED SECTION -->
        {% for post in posts %}
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-3">
                
                <!-- Post Header & Edit Menu -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="d-flex align-items-center">
                        <!-- User Image (Fixed Visibility) -->
                        <img src="{{ post.author.profile.image.url }}" 
                             onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';"
                             class="rounded-circle me-2 border" 
                             style="width: 45px; height: 45px; object-fit: cover; aspect-ratio: 1/1; object-position: center;">
                        <div>
                            <h6 class="fw-bold mb-0 text-dark">{{ post.author.username }}</h6>
                            <small class="text-muted" style="font-size: 0.75rem;">{{ post.date_posted|timesince }} ago</small>
                        </div>
                    </div>
                    
                    <!-- THREE DOTS MENU (Circle Removed) -->
                   <!-- THREE DOTS MENU (Fixed Visibility) -->
                    {% if post.author == user %}
                    <div class="dropdown">
                        <!-- Uses standard Bootstrap link styling, dark text, no underline -->
                        <button class="btn btn-link text-dark text-decoration-none p-0 border-0" 
                                type="button" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false"
                                style="font-size: 1.5rem; line-height: 1;">
                            &#8230; <!-- This is the HTML code for horizontal dots -->
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                            <li><a class="dropdown-item" href="{% url 'post-update' post.id %}">‚úèÔ∏è Edit</a></li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'post-delete' post.id %}" 
                                   onclick="return confirm('Are you sure you want to delete this?');">
                                   üóëÔ∏è Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- Post Content -->
                <p class="card-text fs-5 mb-3">{{ post.content|linebreaksbr }}</p>

                {% if post.image %}
                <div class="mb-3">
                    <img src="{{ post.image.url }}" class="img-fluid rounded-3 w-100 border" style="max-height: 500px; object-fit: cover;">
                </div>
                {% endif %}

                <!-- Action Buttons (AJAX LIKE & REPOST) -->
                <div class="d-flex align-items-center gap-2 border-top border-bottom py-2 mb-3">
                    
                    <!-- LIKE BUTTON -->
                    <button onclick="toggleLike({{ post.id }})" 
                            class="btn btn-light btn-sm px-3 fw-bold border rounded-pill d-flex align-items-center gap-1"
                            style="transition: 0.2s;">
                        <span id="like-icon-{{ post.id }}" style="font-size: 1.1rem;">
                            {% if user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                        </span>
                        <span id="like-count-{{ post.id }}" class="text-muted">
                            {{ post.likes.count }}
                        </span>
                        <span class="text-secondary ms-1">Like</span>
                    </button>
                    
                    <!-- REPOST BUTTON -->
                    <a href="{% url 'post-repost' post.id %}" class="btn btn-light btn-sm px-3 fw-bold border rounded-pill text-decoration-none d-flex align-items-center gap-1">
                        <span class="text-primary" style="font-size: 1.1rem;">üîÑ</span> 
                        <span class="text-secondary">Repost</span>
                    </a>

                </div>

                <!-- Comments -->
                <div class="bg-light p-3 rounded-3">
                    {% for comment in post.comments.all %}
                        <div class="d-flex mb-2">
                            <div class="flex-grow-1">
                                <div class="bg-white p-2 rounded-3 border {% if comment.is_ai %}border-success{% endif %}">
                                    <strong class="d-block small {% if comment.is_ai %}text-success{% else %}text-dark{% endif %}">
                                        {{ comment.author_name }} {% if comment.is_ai %}‚ú®{% endif %}
                                    </strong>
                                    <span class="small">{{ comment.content }}</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- Comment Input -->
                    <form method="POST" class="d-flex mt-2 align-items-center">
                        {% csrf_token %}
                        <input type="hidden" name="post_id" value="{{ post.id }}">
                        <!-- Current User Image in Comment Input (Fixed Visibility) -->
                        <img src="{{ user.profile.image.url }}" 
                             onerror="this.onerror=null;this.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';"
                             class="rounded-circle me-2" 
                             style="width: 30px; height: 30px; object-fit: cover; aspect-ratio: 1/1; object-position: center;">
                        
                        <input type="text" name="comment_content" class="form-control rounded-pill bg-white border-0" placeholder="Write a comment..." required>
                        
                        <!-- GREEN SEND BUTTON -->
                        <button type="submit" class="btn btn-link text-success text-decoration-none fw-bold ms-2">Send</button>
                    </form>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    function toggleLike(postId) {
        const url = `/like/${postId}/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const iconSpan = document.getElementById(`like-icon-${postId}`);
            const countSpan = document.getElementById(`like-count-${postId}`);
            
            countSpan.innerText = data.total_likes;
            
            if (data.liked) {
                iconSpan.innerText = "‚ù§Ô∏è";
            } else {
                iconSpan.innerText = "ü§ç";
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}